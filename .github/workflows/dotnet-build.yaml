name: dotnet-build

on:
  workflow_call:
    inputs:
      github_runner_command:
        description: "List of commands to execute before checkout (e.g., 'apt-get update', 'apt-get install -y package'). Commands are executed sequentially."
        required: false
        default: ""
        type: string
      github_runner:
        description: "Specifies the runner instance for the job"
        default: "ubuntu-latest"
        required: false
        type: string
      dotnet_version:
        description: "Specifies the .NET SDK version to use."
        required: false
        default: "10.0.x"
        type: string
      dotnet_nuget_source_url:
        description: "URL for the custom NuGet source."
        required: false
        default: "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"
        type: string
      dotnet_nuget_source_name:
        description: "Name for the custom NuGet source."
        required: false
        default: "github"
        type: string
      dotnet_nuget_store_password_clear_text:
        description: "Flag to store the NuGet password in clear text."
        required: false
        default: true
        type: boolean
      dotnet_run_tests:
        description: "Flag to enable or disable running tests."
        required: false
        default: true
        type: boolean
      dotnet_build_no_restore:
        description: "Flag to enable or disable the --no-restore option during build."
        required: false
        default: true
        type: boolean
      dotnet_build_configuration:
        description: "Build configuration (e.g., Debug or Release)."
        required: false
        default: "Release"
        type: string
      dotnet_cache_enabled:
        description: "Flag to enable or disable caching Nuget packages"
        required: false
        default: true
        type: boolean
      dotnet_install_dir:
        description: "Directory to install the .NET SDK."
        required: false
        default: "$HOME/.dotnet"
        type: string
      sonar_analysis_enabled:
        description: "Flag to enable SonarQube analysis for the .NET build."
        required: false
        default: false
        type: boolean
      sonar_project_key:
        description: "SonarQube project key."
        required: false
        default: ""
        type: string
      sonar_host_url:
        description: "SonarQube host URL (e.g., https://sonarcloud.io)."
        required: false
        default: "https://sonarcloud.io"
        type: string
      slack_enabled:
        description: "Flag to enable Slack notifications"
        required: false
        default: false
        type: boolean
      slack_username:
        description: "Slack username for the notification"
        required: false
        default: "bot"
        type: string
      slack_channel:
        description: "Slack channel name for the notification"
        required: false
        default: "slack-notification"
        type: string
      slack_title:
        description: "Slack title of the notification"
        required: false
        default: "Build"
        type: string         
    secrets:
      NUGET_USERNAME:
        required: false
      NUGET_PASSWORD:
        required: false
      SLACK_WEBHOOK:
        required: false
      SONAR_TOKEN:
        required: false
jobs:
  build:
    runs-on: ${{ inputs.github_runner }}
    env:
      DOTNET_INSTALL_DIR: ${{ inputs.dotnet_install_dir }}
    steps:
      - name: Execute runner commands
        if: ${{ inputs.github_runner_command != '' }}
        run: ${{ inputs.github_runner_command }}

      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v5.1.0
        with:
          dotnet-version: ${{ inputs.dotnet_version }}

      - name: Cache NuGet packages
        if: ${{ inputs.dotnet_cache_enabled }}
        uses: actions/cache@v5
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Add .NET NuGet source
        if: ${{ inputs.dotnet_nuget_source_url != '' }}
        run: |
          dotnet nuget add source ${{ inputs.dotnet_nuget_source_url }} \
            --name ${{ inputs.dotnet_nuget_source_name }} \
            --username ${{ secrets.NUGET_USERNAME }} \
            --password ${{ secrets.NUGET_PASSWORD }} \
            ${{ inputs.dotnet_nuget_store_password_clear_text && '--store-password-in-clear-text' || '' }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: |
          dotnet build ${{ inputs.dotnet_build_no_restore && '--no-restore' || '' }} --configuration ${{ inputs.dotnet_build_configuration }}

      - name: Run tests
        if: ${{ inputs.dotnet_run_tests }}
        run: dotnet test --verbosity normal

      - name: SonarQube analysis
        if: ${{ inputs.sonar_analysis_enabled }}
        run: |
          dotnet tool install --global dotnet-sonarscanner || true
          export PATH="$HOME/.dotnet/tools:$PATH"
          dotnet sonarscanner begin /k:"${{ inputs.sonar_project_key }}" /d:sonar.host.url="${{ inputs.sonar_host_url }}" /d:sonar.login="${{ secrets.SONAR_TOKEN }}"
          dotnet sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"
          
      - name: Slack Notification
        uses: rtCamp/action-slack-notify@v2
        if: ${{ inputs.slack_enabled }}
        env:
          SLACK_USERNAME: ${{ inputs.slack_username }}
          SLACK_CHANNEL: ${{ inputs.slack_channel }}
          SLACK_COLOR: ${{ job.status }}
          SLACK_TITLE: ${{ inputs.slack_title }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}        
