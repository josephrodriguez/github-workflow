name: golang-build

on:
  workflow_call:
    inputs:
      go_version:
        description: "Specifies the Go version to use."
        required: false
        default: "1.24"
        type: string
      go_modules_enabled:
        description: "Flag to enable or disable Go modules."
        required: false
        default: true
        type: boolean
      go_tests_enabled:
        description: "Flag to enable or disable running tests."
        required: false
        default: true
        type: boolean
      go_cache_enabled:
        description: "Flag to enable or disable caching Go modules and build cache."
        required: false
        default: true
        type: boolean
      go_coverage_enabled:
        description: "Flag to enable or disable code coverage analysis."
        required: false
        default: true
        type: boolean
      go_coverage_threshold:
        description: "Minimum code coverage threshold percentage."
        required: false
        default: "70"
        type: string
      go_build_ldflags:
        description: "LDFLAGS for the Go build to inject build variables."
        required: false
        default: ""
        type: string
      go_build_gcflags:
        description: "GCFLAGS for the Go build (compiler flags). Example: '-N -l' for disabling optimizations."
        required: false
        default: ""
        type: string
      go_build_output_dir:
        description: "Output directory for compiled binaries."
        required: false
        default: "./bin"
        type: string
      go_build_os:
        description: "Target operating system for the build (e.g., 'linux', 'windows', 'darwin')."
        required: false
        default: "linux"
        type: string
      go_build_arch:
        description: "Target architecture for the build (e.g., 'amd64', 'arm64', '386')."
        required: false
        default: "amd64"
        type: string
      go_build_output_name:
        description: "Output binary name (without extension). Extension will be added automatically based on target OS."
        required: false
        default: ""
        type: string
      go_lint_enabled:
        description: "Flag to enable or disable running golangci-lint."
        required: false
        default: false
        type: boolean        
      go_lint_timeout:
        description: "Timeout for golangci-lint (e.g., '5m')."
        required: false
        default: "5m"
        type: string
      go_project_dir:
        description: "Path to the Go project directory to build. If empty, builds from root."
        required: false
        default: ""
        type: string
      go_artifacts_enabled:
        description: "Flag to enable or disable uploading build artifacts."
        required: false
        default: true
        type: boolean
      go_artifacts_name:
        description: "Name for the uploaded artifacts."
        required: false
        default: ""
        type: string
      sonar_cache_enabled:
        description: "Flag to enable or disable caching SonarQube packages."
        required: false
        default: true
        type: boolean
      sonar_analysis_enabled:
        description: "Flag to enable SonarQube analysis."
        required: false
        default: false
        type: boolean
      sonar_project_key:
        description: "SonarQube project key."
        required: false
        default: ""
        type: string
      sonar_host_url:
        description: "SonarQube host URL."
        required: false
        default: "https://sonarcloud.io"
        type: string
      slack_enabled:
        description: "Flag to enable Slack notifications"
        required: false
        default: false
        type: boolean
      slack_username:
        description: "Slack username for the notification"
        required: false
        default: "bot"
        type: string
      slack_channel:
        description: "Slack channel name for the notification"
        required: false
        default: "slack-notification"
        type: string
      slack_title:
        description: "Slack title of the notification"
        required: false
        default: "Golang Build"
        type: string
      github_runner_os_version:
        description: "Runner operating system"
        default: "ubuntu-latest"
        required: false
        type: string
    secrets:
      SONAR_TOKEN:
        required: false
      SLACK_WEBHOOK:
        required: false

jobs:
  build:
    runs-on: ${{ inputs.github_runner_os_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ inputs.go_version }}

      - name: Cache Go modules
        if: ${{ inputs.go_cache_enabled }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Cache SonarQube Cloud packages
        if: ${{ inputs.sonar_analysis_enabled && inputs.sonar_cache_enabled}}
        uses: actions/cache@v4
        with:
          path: ~\sonar\cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar            

      - name: Download dependencies
        if: ${{ inputs.go_modules_enabled }}
        run: go mod download

      - name: Verify dependencies
        if: ${{ inputs.go_modules_enabled }}
        run: go mod verify

      - name: Run linting
        if: ${{ inputs.go_lint_enabled }}
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          args: --timeout=${{ inputs.go_lint_timeout }}

      - name: Run tests
        if: ${{ inputs.go_tests_enabled }}
        run: |
          go test -v -race -coverprofile=coverage.out ./...

      - name: Generate coverage report
        if: ${{ inputs.go_coverage_enabled }}
        run: |
          go tool cover -html=coverage.out -o coverage.html
          go tool cover -func=coverage.out | tee coverage.txt

      - name: Check coverage threshold
        if: ${{ inputs.go_coverage_enabled }}
        run: |
          set -o pipefail
          coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $NF}' | sed 's/%//')
          threshold=${{ inputs.go_coverage_threshold }}
          
          echo "========================================"
          echo "Coverage Check Report"
          echo "========================================"
          echo "Current Coverage:  ${coverage}%"
          echo "Required Threshold: ${threshold}%"
          echo "========================================"
          
          # Compare as integers to avoid float issues
          coverage_int=$(printf "%.0f" "${coverage}")
          
          if [ "${coverage_int}" -lt "${threshold}" ]; then
            echo "❌ FAILED: Coverage (${coverage}%) is below threshold (${threshold}%)"
            echo "Difference: $(( threshold - coverage_int ))%"
            exit 1
          else
            echo "✅ PASSED: Coverage (${coverage}%) meets or exceeds threshold (${threshold}%)"
            echo "Margin: $(( coverage_int - threshold ))%"
          fi

      - name: Build binaries
        run: |
          mkdir -p ${{ inputs.go_build_output_dir }}
          if [ -n "${{ inputs.go_project_dir }}" ]; then
            cd "${{ inputs.go_project_dir }}"
          fi
          GOOS=${{ inputs.go_build_os }} GOARCH=${{ inputs.go_build_arch }} go build \
            -ldflags "${{ inputs.go_build_ldflags }}" \
            -gcflags "${{ inputs.go_build_gcflags }}" \
            -o "${{ github.workspace }}/${{ inputs.go_build_output_dir }}/${{ inputs.go_build_output_name }}" \
            .

      - name: List generated binaries
        run: |
          echo "Generated binaries:"
          ls -lh ${{ inputs.go_build_output_dir }}/

      - name: SonarQube analysis
        if: ${{ inputs.sonar_analysis_enabled }}
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=${{ inputs.sonar_project_key }}
            -Dsonar.host.url=${{ inputs.sonar_host_url }}
            -Dsonar.go.coverage.reportPaths=coverage.out

      - name: Upload artifacts
        if: ${{ inputs.go_artifacts_enabled }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.go_artifacts_name || inputs.go_build_output_name }}
          path: ${{ inputs.go_build_output_dir }}/
          retention-days: 30

      - name: Slack Notification
        uses: rtCamp/action-slack-notify@v2
        if: ${{ inputs.slack_enabled }}
        env:
          SLACK_USERNAME: ${{ inputs.slack_username }}
          SLACK_CHANNEL: ${{ inputs.slack_channel }}
          SLACK_COLOR: ${{ job.status }}
          SLACK_TITLE: ${{ inputs.slack_title }}
          SLACK_MESSAGE: |
            Go version: ${{ inputs.go_version }}
            Status: ${{ job.status }}
            OS: ${{ inputs.go_build_os }}
            Architecture: ${{ inputs.go_build_arch }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
